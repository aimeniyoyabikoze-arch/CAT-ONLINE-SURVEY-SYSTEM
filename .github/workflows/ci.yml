name: CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  # Job 1: Checkout and Setup
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci

  # Job 2: Lint Backend Code
  lint-backend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Run ESLint
        run: npm run lint

  # Job 3: Run Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Run Unit Tests
        run: npm test

  # Job 4: Code Coverage
  coverage:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Generate Coverage Report
        run: npm test
      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json

  # Job 5: Security Audit
  security-audit:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

  # Job 6: Build Docker Image
  docker-build:
    runs-on: ubuntu-latest
    needs: [lint-backend, unit-tests]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build Docker Image
        run: docker build -t survey-system:${{ github.sha }} .

  # Job 7: Frontend Build Check
  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install --legacy-peer-deps --no-audit --no-fund
      - name: Build frontend
        working-directory: frontend
        run: CI=false npm run build

  # Job 8: Dependency Check
  dependency-check:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Check outdated packages
        run: npm outdated || true

  # Job 9: Code Quality Analysis
  code-quality:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - name: Analyze code structure
        run: |
          echo "Backend files count: $(find . -name '*.js' -not -path './node_modules/*' -not -path './frontend/*' -not -path './public/*' | wc -l)"
          echo "Test files count: $(find . -name '*.test.js' | wc -l)"

  # Job 10: Summary and Status
  status-check:
    runs-on: ubuntu-latest
    needs: [lint-backend, unit-tests, security-audit, docker-build, frontend-build, dependency-check, code-quality, coverage]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          echo "âœ… All jobs completed!"
          echo "Backend Linting: Completed"
          echo "Unit Tests: Completed"
          echo "Security Audit: Completed"
          echo "Docker Build: Completed"
          echo "Frontend Build: Completed"
          echo "Dependency Check: Completed"
          echo "Code Quality: Completed"
          echo "Coverage Report: Completed"
