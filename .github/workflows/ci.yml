name: CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci

  lint-backend:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  unit-tests:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm test

  coverage:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm test
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json

  security-audit:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=moderate || true

  docker-build:
    runs-on: ubuntu-latest
    needs: [lint-backend, unit-tests]
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - run: docker build -t survey-system:${{ github.sha }} .

  deploy:
    runs-on: ubuntu-latest
    needs: [lint-backend, unit-tests, docker-build]
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v3
      - run: |
          echo "ðŸš€ Deployment started for ${{ github.sha }}"
          mkdir -p deploy
          cp -r public/ deploy/
          cp index.js deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          echo "âœ… Deployment artifacts ready"

  dependency-check:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm outdated || true

  code-quality:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: |
          echo "Backend files: $(find . -name '*.js' -not -path './node_modules/*' -not -path './frontend/*' -not -path './public/*' | wc -l)"
          echo "Test files: $(find . -name '*.test.js' | wc -l)"

  status-check:
    runs-on: ubuntu-latest
    needs: [lint-backend, unit-tests, security-audit, docker-build, deploy, dependency-check, code-quality, coverage]
    if: always()
    steps:
      - run: |
          echo "âœ… Pipeline Complete!"
          echo "  - Setup"
          echo "  - Lint Backend"
          echo "  - Unit Tests"
          echo "  - Coverage"
          echo "  - Security Audit"
          echo "  - Docker Build"
          echo "  - Deploy"
          echo "  - Dependency Check"
          echo "  - Code Quality"

  notify-slack:
    runs-on: ubuntu-latest
    needs: [lint-backend, unit-tests, security-audit, docker-build, deploy, dependency-check, code-quality, coverage]
    if: always()
    steps:
      - name: Determine Status
        id: status
        run: |
          if [[ "${{ needs.lint-backend.result }}" == "failure" || "${{ needs.unit-tests.result }}" == "failure" || "${{ needs.security-audit.result }}" == "failure" || "${{ needs.docker-build.result }}" == "failure" || "${{ needs.deploy.result }}" == "failure" || "${{ needs.dependency-check.result }}" == "failure" || "${{ needs.code-quality.result }}" == "failure" || "${{ needs.coverage.result }}" == "failure" ]]; then
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "CI/CD Pipeline ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CI/CD Pipeline ${{ steps.status.outputs.status }}*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Job Results:*\nâ€¢ Lint Backend: ${{ needs.lint-backend.result }}\nâ€¢ Unit Tests: ${{ needs.unit-tests.result }}\nâ€¢ Coverage: ${{ needs.coverage.result }}\nâ€¢ Security Audit: ${{ needs.security-audit.result }}\nâ€¢ Docker Build: ${{ needs.docker-build.result }}\nâ€¢ Deploy: ${{ needs.deploy.result }}\nâ€¢ Dependency Check: ${{ needs.dependency-check.result }}\nâ€¢ Code Quality: ${{ needs.code-quality.result }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
